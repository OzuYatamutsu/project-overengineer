FROM hashicorp/vault:1.18

# Should be set to the host's non-FQDN name (e.g., vault-0).
ENV CONTAINER_NAME ""

# Should be set to either "primary" or "secondary" at runtime.
ENV HA_ROLE ""

# This container is used to automate init and unseal of the vault
# primary at apply time.

# Install vault certificate
RUN apk add --no-cache curl jq kubectl ca-certificates
COPY vault.crt /usr/local/share/ca-certificates/vault.crt
RUN update-ca-certificates

# Run unseal script at runtime
WORKDIR /vault
COPY vault/unseal-vault.sh /vault/unseal-vault.sh
COPY vault/unseal-vault-primary.sh /vault/unseal-vault-primary.sh
COPY vault/unseal-vault-secondary.sh /vault/unseal-vault-secondary.sh
RUN chmod +x /vault/unseal-vault.sh
RUN chmod +x /vault/unseal-primary.sh
RUN chmod +x /vault/unseal-secondary.sh

# debug
RUN ls -rlat /vault
ENTRYPOINT ["/vault/unseal-vault.sh"]
